```настояший игру сделай про стрелбу  все 3d в html штобы они двигалис стреляли хп была скина на  оружыя разны виды оружыя на персонас скин донатерский скины штобы можна была сделай как pubg mobile лобби как в pubg с друзями мождна была pvp сделай робочий хороший качественый идиалный болший 3d карты как в pubg !все 3d была ```


<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Battle Ultra — 3D BR Demo (one file)</title>
<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<style>
  :root{--ui:#e6eef8;--muted:#9aa6bd;--accent:#16a34a}
  html,body{height:100%;margin:0;background:#071026;font-family:Inter,Arial,Helvetica,sans-serif;overflow:hidden}
  canvas{display:block}
  /* HUD & UI */
  .hud{position:fixed;left:12px;top:12px;color:var(--ui);z-index:40}
  .hud .row{display:flex;gap:10px;align-items:center}
  .panel{background:rgba(2,6,23,0.6);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  #centerMenu{position:fixed;left:50%;top:6%;transform:translateX(-50%);width:880px;z-index:50}
  #centerMenu .card{padding:18px;border-radius:12px;background:rgba(3,6,12,0.85);border:1px solid rgba(255,255,255,0.04);color:var(--ui)}
  #shopModal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:60;display:none;width:820px}
  button{background:var(--accent);border:0;color:#021;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--ui);padding:8px 10px;border-radius:8px;cursor:pointer}
  input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--ui)}
  .muted{color:var(--muted)}
  #crosshair{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:45;pointer-events:none}
  #crosshair:before,#crosshair:after{content:'';position:absolute;background:var(--ui)}
  #crosshair:before{left:50%;top:0;width:2px;height:12px;transform:translateX(-50%)}
  #crosshair:after{top:50%;left:0;height:2px;width:12px;transform:translateY(-50%)}
  /* inventory/shop */
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .slot{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;text-align:center}
  /* small devices */
  @media(max-width:900px){
    #centerMenu{width:94%}
    #shopModal{width:94%}
  }
</style>
</head>
<body>
<canvas id="c"></canvas>
<div class="dd">

</div>
<!-- HUD -->
<div class="hud">
  <div class="panel" id="hudTop">
    <div class="row" style="justify-content:space-between;align-items:center;width:760px">
      <div>    <a href="index.html">aa</a>
    <a href="INDEX3.HTML">bb</a>
        <div style="font-weight:800" id="pname">Player</div>
        <div class="muted" id="prole">Role: user</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Coins</div>
        <div id="coins" style="font-weight:800">0</div>
      </div>
    </div>
    <div style="margin-top:8px" class="row">
      <div class="muted">HP</div>
      <div style="width:220px;background:#071422;border-radius:6px;margin-left:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)">
        <div id="hpBar" style="width:100%;height:12px;background:linear-gradient(90deg,#ff6b6b,#ffb86b)"></div>
      </div>
      <div style="margin-left:auto" id="weaponLabel">Pistol • 12/12</div>
    </div>
  </div>
</div>

<!-- Center menu / lobby -->
<div id="centerMenu">
  <div class="card panel">
    <h1 style="margin:0 0 6px">Battle Ultra — Lobby</h1>
    <div class="muted">Одиночный демо-battle-royale в браузере. Для сети нужен сервер — могу добавить позже.</div>

    <div style="margin-top:12px" class="row">
      <input id="nameInput" placeholder="Введите имя" style="flex:1"/>
      <button id="createBtn" style="margin-left:8px">Create Profile</button>
    </div>

    <div style="margin-top:10px" class="row">
      <button id="startBtn">Start Match (Plane → Drop)</button>
      <button id="shopBtn" class="ghost">Shop</button>
      <button id="invBtn" class="ghost">Inventory</button>
      <button id="settingsBtn" class="ghost">Settings</button>
    </div>

    <div style="margin-top:12px">
      <div class="muted">Skins:</div>
      <div id="skinSwatches" style="margin-top:8px"></div>
    </div>

    <div style="margin-top:8px" class="muted">Управление: WASD — движение, мышь — прицел, LMB — стрелять, R — перезарядка, 1/2/3 — оружие, F — подобрать, E — сесть/выйти из машины, Tab — меню</div>
  </div>
</div>

<!-- Shop modal -->
<div id="shopModal" class="panel" style="display:none">
  <h2 style="margin:0 0 8px">Shop</h2>
  <div class="muted">Купи скин или пакет оружия за монеты (локальные покупки)</div>
  <div style="display:flex;gap:12px;margin-top:12px">
    <div style="flex:1">
      <div style="font-weight:800">Skins</div>
      <div id="shopSkins" style="margin-top:8px" class="grid"></div>
    </div>
    <div style="flex:1">
      <div style="font-weight:800">Weapon Packs</div>
      <div id="shopPacks" style="margin-top:8px" class="grid"></div>
    </div>
  </div>
  <div style="margin-top:12px;text-align:right"><button id="closeShop" class="ghost">Close</button></div>
</div>

<!-- Inventory modal -->
<div id="invModal" class="panel" style="display:none;position:fixed;left:50%;top:60%;transform:translate(-50%,-50%);z-index:60">
  <h3 style="margin:0 0 8px">Inventory</h3>
  <div class="muted">Нажми на предмет, чтобы экипировать/использовать</div>
  <div id="invGrid" class="grid" style="margin-top:8px;min-width:640px"></div>
  <div style="margin-top:12px;text-align:right"><button id="closeInv" class="ghost">Close</button></div>
</div>

<!-- Crosshair -->
<div id="crosshair" aria-hidden="true"></div>

<script>
/* =========================
   STATE & DATA
   ========================= */
const STORAGE_KEY = 'battle_ultra_v1';
let SAVE = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
if(!SAVE.player) {
  SAVE.player = {name: 'Player'+Math.floor(Math.random()*999), coins: 1200, skins:['default'], purchases:{skins:[],packs:[]}, inventory:[]};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(SAVE));
}
function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(SAVE)); }

/* Shop data */
const SKINS = [
  {id:'default', name:'Default', color:'#3b82f6', price:0},
  {id:'desert', name:'Desert', color:'#c68642', price:300},
  {id:'urban', name:'Urban', color:'#6b7280', price:600},
  {id:'gold', name:'Gold (donor)', color:'#f59e0b', price:1500}
];
const PACKS = [
  {id:'basic', name:'Basic Pack', price:0, weapons:[1]},
  {id:'assault', name:'Assault Pack', price:500, weapons:[1,2]},
  {id:'full', name:'Full Pack', price:1200, weapons:[1,2,3]}
];

/* Player profile UI init */
document.getElementById('pname').innerText = SAVE.player.name;
document.getElementById('coins').innerText = SAVE.player.coins;
document.getElementById('nameInput').value = SAVE.player.name;

/* render skin swatches in lobby */
const skinSwatches = document.getElementById('skinSwatches');
SKINS.forEach(s=>{
  const d = document.createElement('div');
  d.className='skin-swatch';
  d.style.background = s.color;
  d.style.width='44px'; d.style.height='28px'; d.style.margin='6px'; d.style.display='inline-block'; d.style.borderRadius='6px';
  d.title = s.name;
  d.onclick = ()=>{ SAVE.player.skins[0]=s.id; persist(); addLog('Applied skin: '+s.name); };
  skinSwatches.appendChild(d);
});

/* shop rendering */
function renderShop(){
  const ss = document.getElementById('shopSkins');
  ss.innerHTML = '';
  SKINS.forEach(s=>{
    const el = document.createElement('div');
    el.className='slot';
    el.innerHTML = `<div style="height:40px;background:${s.color};border-radius:6px;margin-bottom:6px"></div><b>${s.name}</b><div class="muted">${s.price} coins</div><button ${SAVE.player.purchases.skins.includes(s.id)?'disabled':''} onclick="buySkin('${s.id}')">${SAVE.player.purchases.skins.includes(s.id)?'Owned':'Buy'}</button>`;
    ss.appendChild(el);
  });
  const sp = document.getElementById('shopPacks'); sp.innerHTML='';
  PACKS.forEach(p=>{
    const el = document.createElement('div'); el.className='slot';
    el.innerHTML = `<b>${p.name}</b><div class="muted">${p.price} coins</div><button ${SAVE.player.purchases.packs && SAVE.player.purchases.packs.includes(p.id)?'disabled':''} onclick="buyPack('${p.id}')">${SAVE.player.purchases.packs && SAVE.player.purchases.packs.includes(p.id)?'Owned':'Buy'}</button>`;
    sp.appendChild(el);
  });
}
window.buySkin = function(id){
  const skin = SKINS.find(s=>s.id===id);
  if(!skin) return;
  if(SAVE.player.coins < skin.price){ alert('Не хватает монет'); return; }
  SAVE.player.coins -= skin.price;
  SAVE.player.purchases.skins.push(id);
  SAVE.player.skins[0]=id;
  persist(); updateUI(); renderShop(); addLog('Bought skin: '+skin.name);
}
window.buyPack = function(id){
  const pack = PACKS.find(p=>p.id===id);
  if(!pack) return;
  if(SAVE.player.coins < pack.price){ alert('Не хватает монет'); return; }
  SAVE.player.coins -= pack.price;
  SAVE.player.purchases.packs = SAVE.player.purchases.packs || [];
  SAVE.player.purchases.packs.push(id);
  // add weapons to inventory as items
  SAVE.player.inventory.push({type:'pack', id:pack.id, weapons:pack.weapons});
  persist(); updateUI(); renderShop(); addLog('Bought pack: '+pack.name);
}

/* inventory */
function renderInventory(){
  const g = document.getElementById('invGrid'); g.innerHTML = '';
  (SAVE.player.inventory || []).forEach((it,idx)=>{
    const el = document.createElement('div'); el.className='slot';
    el.innerHTML = `<b>${it.type==='pack'?'Pack: '+it.id:it.id||'Item'}</b><div class="muted">Click to use</div><button onclick="useInventory(${idx})">Use</button>`;
    g.appendChild(el);
  });
}
window.useInventory = function(idx){
  const item = SAVE.player.inventory[idx];
  if(!item) return;
  if(item.type==='pack'){ // unlock weapons logically
    // in this demo we just give coins bonus to simulate unlock
    SAVE.player.coins += 200; addLog('Activated pack: '+item.id);
  }
  SAVE.player.inventory.splice(idx,1);
  persist(); renderInventory(); updateUI();
}

/* UI buttons */
document.getElementById('shopBtn').addEventListener('click', ()=>{ document.getElementById('shopModal').style.display='block'; renderShop(); });
document.getElementById('closeShop').addEventListener('click', ()=>{ document.getElementById('shopModal').style.display='none'; });
document.getElementById('invBtn').addEventListener('click', ()=>{ document.getElementById('invModal').style.display='block'; renderInventory(); });
document.getElementById('closeInv').addEventListener('click', ()=>{ document.getElementById('invModal').style.display='none'; });
document.getElementById('createBtn').addEventListener('click', ()=>{ const v=document.getElementById('nameInput').value.trim(); if(v){ SAVE.player.name=v; persist(); document.getElementById('pname').innerText=v; addLog('Profile set: '+v); document.getElementById('centerMenu').style.display='none'; } });
document.getElementById('startBtn').addEventListener('click', ()=>{ startMatch(); document.getElementById('centerMenu').style.display='none'; });

/* debug log area (simple) */
function addLog(t){ const el = document.getElementById('pname'); console.log('[LOG]',t); }

/* =========================
   THREE.JS CORE (WORLD)
   ========================= */
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
scene.fog = new THREE.Fog(0x87ceeb, 500, 3000);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 5000);

/* lights */
scene.add(new THREE.AmbientLight(0xffffff, 0.7));
const sun = new THREE.DirectionalLight(0xffffff, 0.8);
sun.position.set(100,300,100); scene.add(sun);

/* ground (big) */
const groundGeo = new THREE.PlaneGeometry(4000,4000,64,64);
const groundMat = new THREE.MeshStandardMaterial({color:0x2e8b57});
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2; scene.add(ground);

/* basic buildings */
const buildings = [];
function spawnBuildings(n=120){
  for(let i=0;i<n;i++){
    const w=20+Math.random()*120, h=15+Math.random()*120, d=20+Math.random()*120;
    const x=(Math.random()-0.5)*2000, z=(Math.random()-0.5)*2000;
    const g = new THREE.BoxGeometry(w,h,d);
    const m = new THREE.MeshStandardMaterial({color:0x8b8b8b});
    const b = new THREE.Mesh(g,m); b.position.set(x,h/2,z); scene.add(b); buildings.push(b);
  }
}
spawnBuildings(160);

/* trees / rocks (simple) */
const pickups = []; // luts, ammo, coins
function spawnPickups(n=200){
  for(let i=0;i<n;i++){
    const x=(Math.random()-0.5)*3000,z=(Math.random()-0.5)*3000;
    // small box pickup
    const g = new THREE.BoxGeometry(2,2,2);
    const m = new THREE.MeshStandardMaterial({color:0xffff66});
    const p = new THREE.Mesh(g,m);
    p.position.set(x,1,z);
    p.type='loot'; p.value = Math.random()<0.6 ? 'ammo' : (Math.random()<0.5?'coins':'med');
    scene.add(p); pickups.push(p);
  }
}
spawnPickups(300);

/* vehicles (simple box cars) */
const vehicles = [];
function spawnVehicles(n=12){
  for(let i=0;i<n;i++){
    const g = new THREE.BoxGeometry(6,3,12);
    const m = new THREE.MeshStandardMaterial({color:Math.random()*0xffffff});
    const v = new THREE.Mesh(g,m);
    v.position.set((Math.random()-0.5)*1500,1.5,(Math.random()-0.5)*1500);
    v.userData = {occupied:false, speed:0, yaw:0};
    scene.add(v); vehicles.push(v);
  }
}
spawnVehicles(18);

/* player pawn */
function makePawn(color){
  const geo = new THREE.CapsuleGeometry(0.8,1.2,4,8);
  const mat = new THREE.MeshStandardMaterial({color});
  const mesh = new THREE.Mesh(geo, mat); mesh.castShadow=true; mesh.receiveShadow=true;
  return mesh;
}
let players = []; // list of player objects (local + bots)
function createPlayerObj(name, skinId, isLocal=false){
  const color = (SKINS.find(s=>s.id===skinId)||SKINS[0]).color;
  const mesh = makePawn(color);
  scene.add(mesh);
  const obj = {
    id: Math.random().toString(36).slice(2),
    name, skinId, mesh,
    pos: mesh.position, vel: new THREE.Vector3(),
    yaw: 0, pitch:0, hp: 100, alive:true,
    weapon:1, ammo:{1:12,2:30,3:8}, fireCooldown:0,
    isLocal
  };
  return obj;
}
const localPlayer = createPlayerObj(SAVE.player.name, SAVE.player.skins[0]||'default', true);
localPlayer.pos.set(0,2,0); players.push(localPlayer);

/* spawn bots */
function spawnBots(n=18){
  for(let i=0;i<n;i++){
    const b = createPlayerObj('Bot'+Math.floor(Math.random()*999), SKINS[Math.floor(Math.random()*SKINS.length)].id, false);
    b.pos.set((Math.random()-0.5)*1800,2,(Math.random()-0.5)*1800);
    players.push(b);
  }
}
spawnBots(22);

/* bullets pool */
const bulletPool = []; const activeBullets = [];
function makeBulletMesh(){ const g = new THREE.SphereGeometry(0.08,6,6); const m = new THREE.MeshStandardMaterial({color:0xffe066}); const s = new THREE.Mesh(g,m); s.visible=false; scene.add(s); bulletPool.push(s); }
for(let i=0;i<180;i++) makeBulletMesh();
function getBullet(){ if(bulletPool.length===0) return null; const b=bulletPool.pop(); b.visible=true; activeBullets.push(b); return b; }
function recycleBullet(b){ b.visible=false; const i=activeBullets.indexOf(b); if(i>=0) activeBullets.splice(i,1); bulletPool.push(b); }

/* weapon config */
const WEAPONS = {
  1:{name:'Pistol', dmg:20, rpm:300, mag:12, reload:1.1, spread:0.012},
  2:{name:'Rifle', dmg:12, rpm:700, mag:30, reload:2.4, spread:0.02},
  3:{name:'Shotgun', dmg:9, rpm:70, mag:8, reload:2.6, spread:0.16, pellets:6}
};

/* input & pointer lock */
let keys = {}; window.addEventListener('keydown', e=> keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e=> keys[e.key.toLowerCase()] = false);
canvas.addEventListener('click', ()=> { if(document.pointerLockElement!==canvas) canvas.requestPointerLock?.(); } );
let mouseDX=0, mouseDY=0; document.addEventListener('mousemove', e=>{ if(document.pointerLockElement===canvas){ mouseDX += e.movementX * 0.002; mouseDY += e.movementY * 0.002; } });
let mouseDown=false; window.addEventListener('mousedown', ()=> mouseDown=true); window.addEventListener('mouseup', ()=> mouseDown=false);

/* helper: raycast */
const rc = new THREE.Raycaster();

/* physics-ish variables */
let gravity = -30, velY = 0, grounded = true;

/* zone (shrinking circle) */
let zone = {center:new THREE.Vector2(0,0), radius:1200, shrinkTarget:300, shrinkSpeed:0.02, stage:0, nextShrinkTime:0};
function updateZone(dt){
  // every X seconds reduce radius
  zone.radius = Math.max(zone.shrinkTarget, zone.radius - zone.shrinkSpeed*dt*60);
  // heavy damage outside zone
  players.forEach(p=>{
    const d = Math.hypot(p.pos.x - zone.center.x, p.pos.z - zone.center.y);
    if(d > zone.radius && p.alive){
      p.hp -= 10 * dt; // damage per second
      if(p.isLocal) updateHpUI();
    }
  });
  document.getElementById('hudTop').querySelector('#zoneLabel')?.remove?.();
}

/* small helpers UI */
function updateHpUI(){ const perc = Math.max(0, localPlayer.hp); document.getElementById('hpBar').style.width = perc+'%'; document.getElementById('coins').innerText = SAVE.player.coins; document.getElementById('weaponLabel').innerText = WEAPONS[localPlayer.weapon].name + ' • ' + (localPlayer.ammo[localPlayer.weapon]||0)+'/'+WEAPONS[localPlayer.weapon].mag; }

/* pickup interaction */
function tryPickup(p){
  for(let i=pickups.length-1;i>=0;i--){
    const it = pickups[i];
    if(it.position.distanceTo(p.pos) < 2.2){
      // pick up
      if(it.value==='ammo'){ p.ammo[1]+=6; p.ammo[2]+=12; p.ammo[3]+=2; addLog('Picked up ammo'); }
      else if(it.value==='coins'){ SAVE.player.coins += 50; addLog('Picked up +50 coins'); }
      else if(it.value==='med'){ p.hp = Math.min(100, p.hp + 40); addLog('Used medkit'); if(p.isLocal) updateHpUI(); }
      scene.remove(it); pickups.splice(i,1);
      persist();
    }
  }
}

/* shooting function */
function spawnBullet(shooter, dir, speed, dmg){
  const b = getBullet();
  if(!b) return;
  b.position.copy(shooter.pos).add(new THREE.Vector3(0,1.4,0));
  b.userData = {dir:dir.clone(), speed, dmg, owner:shooter, life:2.4};
}
function fireWeapon(shooter){
  if(!shooter.alive) return;
  const w = WEAPONS[shooter.weapon];
  if((shooter.ammo[shooter.weapon]||0) <= 0) return;
  if(shooter.fireCooldown && shooter.fireCooldown > 0) return;
  shooter.fireCooldown = 60 / w.rpm;
  shooter.ammo[shooter.weapon] = (shooter.ammo[shooter.weapon]||0) - 1;
  const pellets = w.pellets || 1;
  for(let i=0;i<pellets;i++){
    const spreadX = (Math.random()-0.5) * w.spread;
    const spreadY = (Math.random()-0.5) * w.spread;
    let dir;
    if(shooter.isLocal){
      dir = new THREE.Vector3(); camera.getWorldDirection(dir);
      dir.x += spreadX; dir.y += spreadY; dir.normalize();
    } else {
      dir = new THREE.Vector3().subVectors(localPlayer.pos, shooter.pos).normalize();
      dir.x += spreadX; dir.y += spreadY; dir.normalize();
    }
    spawnBullet(shooter, dir, 200, w.dmg);
  }
  if(shooter.isLocal) updateHpUI();
}

/* bullets update */
function updateBullets(dt){
  for(let i=activeBullets.length-1;i>=0;i--){
    const b = activeBullets[i];
    b.position.addScaledVector(b.userData.dir, b.userData.speed * dt);
    b.userData.life -= dt;
    // collision with players
    for(const p of players){
      if(!p.alive) continue;
      if(p === b.userData.owner) continue;
      if(b.position.distanceTo(p.pos) < 1.2){
        p.hp -= b.userData.dmg;
        if(p.hp <= 0){ p.alive = false; addLog(p.name + ' was killed'); if(p.isLocal) addLog('You died'); }
        recycleBullet(b);
        break;
      }
    }
    // collision with obstacles
    for(const bld of buildings){
      if(b.position.distanceTo(bld.position) < Math.max(bld.geometry.parameters.width,10)){
        recycleBullet(b); break;
      }
    }
    if(b.userData.life <= 0 && activeBullets.includes(b)) recycleBullet(b);
  }
}

/* simple AI */
function updateBots(dt){
  for(const p of players){
    if(p.isLocal) continue;
    if(!p.alive){
      if(Math.random() < 0.0002) { p.hp = 100; p.alive = true; p.pos.set((Math.random()-0.5)*1500,2,(Math.random()-0.5)*1500); }
      continue;
    }
    // simple behavior: move toward local player if close, otherwise roam
    const toLocal = new THREE.Vector3().subVectors(localPlayer.pos, p.pos);
    const dist = toLocal.length();
    if(dist < 120){
      toLocal.y = 0; toLocal.normalize();
      p.pos.addScaledVector(toLocal, 20 * dt);
      // shoot occasionally
      if(Math.random() < 0.02) fireWeapon(p);
    } else {
      // roam
      if(!p._r || p._r.t <= 0){ p._r = {dir:new THREE.Vector3((Math.random()-0.5),0,(Math.random()-0.5)).normalize(), t: 1+Math.random()*3}; }
      p.pos.addScaledVector(p._r.dir, 4 * dt); p._r.t -= dt;
    }
    p.mesh.position.copy(p.pos);
  }
}

/* local player update */
function updateLocal(dt){
  // look
  localPlayer.yaw -= mouseDX; localPlayer.pitch = Math.max(-1.2, Math.min(1.2, localPlayer.pitch - mouseDY));
  mouseDX = mouseDY = 0;
  // movement relative to yaw
  const forward = new THREE.Vector3(Math.sin(localPlayer.yaw),0,Math.cos(localPlayer.yaw));
  const right = new THREE.Vector3(Math.sin(localPlayer.yaw+Math.PI/2),0,Math.cos(localPlayer.yaw+Math.PI/2));
  let move = new THREE.Vector3();
  if(keys['w']) move.add(forward);
  if(keys['s']) move.sub(forward);
  if(keys['a']) move.sub(right);
  if(keys['d']) move.add(right);
  if(move.lengthSq()>0) move.normalize();
  const speed = keys['shift'] ? 16 : 8;
  localPlayer.pos.addScaledVector(move, speed * dt);
  // gravity & jump
  if(grounded && keys[' ']){ velY = 12; grounded=false; }
  velY += gravity * dt;
  localPlayer.pos.y += velY * dt;
  if(localPlayer.pos.y <= 2){ localPlayer.pos.y = 2; velY = 0; grounded = true; }
  // camera
  camera.position.lerp(new THREE.Vector3(localPlayer.pos.x, localPlayer.pos.y + 1.6, localPlayer.pos.z - 0.1), 0.12);
  camera.rotation.set(localPlayer.pitch, localPlayer.yaw + Math.PI, 0, 'ZYX');
  // aim & fire
  if(localPlayer.fireCooldown > 0) localPlayer.fireCooldown -= dt;
  if(mouseDown) fireWeapon(localPlayer);
  // switch weapons
  if(keys['1']){ localPlayer.weapon = 1; keys['1']=false; updateHpUI(); }
  if(keys['2']){ localPlayer.weapon = 2; keys['2']=false; updateHpUI(); }
  if(keys['3']){ localPlayer.weapon = 3; keys['3']=false; updateHpUI(); }
  if(keys['r']){ reloadWeapon(localPlayer); keys['r']=false; }
  // pickups
  tryPickup(localPlayer);
}

/* reload */
function reloadWeapon(p){
  const w = WEAPONS[p.weapon];
  setTimeout(()=>{ p.ammo[p.weapon] = w.mag; if(p.isLocal) updateHpUI(); }, w.reload*1000);
}

/* respawn */
function respawn(p){
  p.hp = 100; p.alive = true; p.pos.set((Math.random()-0.5)*200,2,(Math.random()-0.5)*200); p.mesh.position.copy(p.pos);
  p.ammo = {1:WEAPONS[1].mag,2:WEAPONS[2].mag,3:WEAPONS[3].mag};
  if(p.isLocal) updateHpUI();
}

/* pick up vehicles (enter/exit) */
let inVehicle = null;
function tryEnterVehicle(){
  if(inVehicle){ // exit
    inVehicle.userData.occupied=false;
    localPlayer.pos.copy(inVehicle.position).add(new THREE.Vector3(8,0,0));
    inVehicle = null;
    addLog('Exited vehicle');
    return;
  }
  for(const v of vehicles){
    if(v.position.distanceTo(localPlayer.pos) < 6 && !v.userData.occupied){
      inVehicle = v; v.userData.occupied=true; addLog('Entered vehicle'); break;
    }
  }
}

/* update vehicles */
function updateVehicles(dt){
  for(const v of vehicles){
    if(v === inVehicle){
      // control vehicle with WASD
      if(keys['w']) v.userData.speed = Math.min(60, v.userData.speed + 60 * dt);
      if(keys['s']) v.userData.speed = Math.max(-25, v.userData.speed - 60 * dt);
      if(!keys['w'] && !keys['s']) v.userData.speed *= 0.98;
      if(keys['a']) v.userData.yaw += 1.2 * dt * (v.userData.speed>0?1:-1);
      if(keys['d']) v.userData.yaw -= 1.2 * dt * (v.userData.speed>0?1:-1);
      // apply movement
      v.rotation.y = v.userData.yaw;
      v.position.x += -Math.sin(v.userData.yaw) * v.userData.speed * dt;
      v.position.z += -Math.cos(v.userData.yaw) * v.userData.speed * dt;
      // keep local player attached
      localPlayer.pos.copy(v.position).add(new THREE.Vector3(0,2.2,0));
      v.userData.speed *= 0.995;
    } else {
      // small idle bobbing
      v.position.y = 1.5 + Math.sin(perfTime()*0.5 + v.id) * 0.05;
    }
  }
}

/* tiny performance time helper */
function perfTime(){ return performance.now()/1000; }

/* main loop */
let last = performance.now();
function animate(){
  const now = performance.now(); const dt = Math.min(0.05,(now-last)/1000); last = now;
  // update bots
  updateBots(dt);
  // update local player
  updateLocal(dt);
  // bullets
  updateBullets(dt);
  // vehicles
  updateVehicles(dt);
  // update players mesh positions
  players.forEach(p=>{
    p.mesh.position.copy(p.pos);
    if(!p.alive) p.mesh.material.color.set(0x333333);
    else p.mesh.material.color.set((SKINS.find(s=>s.id===p.skinId)||SKINS[0]).color);
  });
  // update zone / damage
  updateZone(dt);
  // HUD
  updateHpUI();
  // render
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}
animate();

/* handle various keys */
window.addEventListener('keydown', e=>{
  if(e.key==='Tab'){ e.preventDefault(); const cm = document.getElementById('centerMenu'); cm.style.display = cm.style.display === 'none' ? 'block' : 'none'; }
  if(e.key.toLowerCase()==='f'){ // pickup
    // try to pick up nearest pickup
    for(let i=0;i<pickups.length;i++){
      const pk = pickups[i];
      if(pk.position.distanceTo(localPlayer.pos) < 3){
        // add to inventory or apply
        if(pk.value === 'coins'){ SAVE.player.coins += 50; addLog('+50 coins'); }
        else if(pk.value === 'ammo'){ localPlayer.ammo[1]+=6; localPlayer.ammo[2]+=12; localPlayer.ammo[3]+=2; addLog('Picked ammo'); }
        else if(pk.value === 'med'){ localPlayer.hp = Math.min(100, localPlayer.hp + 40); addLog('Used med'); }
        scene.remove(pk); pickups.splice(i,1); persist(); break;
      }
    }
  }
  if(e.key.toLowerCase()==='e'){ tryEnterVehicle(); }
  if(e.key.toLowerCase()==='g'){ // open/close shop
    const sh = document.getElementById('shopModal'); sh.style.display = sh.style.display === 'block' ? 'none' : 'block';
  }
});

/* spawn pickups array is global variable created earlier */

/* gameplay flow: start match (plane etc.) */
let matchStarted = false;
function startMatch(){
  // Plane drop simulation: place players high and allow parachute (simple)
  matchStarted = true;
  // reposition local and bots along plane path
  const planeDir = new THREE.Vector3(1,0,0);
  const baseX = -1500;
  for(let i=0;i<players.length;i++){
    const p = players[i];
    p.pos.set(baseX + i*6, 150 + Math.random()*30, -300 + Math.random()*400);
    p.alive = true; p.hp = 100; p.ammo = {1:WEAPONS[1].mag,2:WEAPONS[2].mag,3:WEAPONS[3].mag};
    p.mesh.position.copy(p.pos);
  }
  // allow parachute: while y > 2 player is falling, can press space to deploy (we'll just slow descent)
  addLog('Plane dropped — press Space to glide slower!');
  // hide lobby if shown
  document.getElementById('centerMenu').style.display = 'none';
}
function addLog(txt){ console.log(txt); }

/* parachute handling (very simple) */
setInterval(()=>{
  if(!matchStarted) return;
  players.forEach(p=>{
    if(p.pos.y > 2){
      // falling
      p.pos.y -= 0.7 + Math.random()*0.2;
      if(p.isLocal && keys[' ']) p.pos.y += 0.5; // hold space to slow descent
      p.mesh.position.copy(p.pos);
    }
  });
}, 1000/30);

/* window resize */
window.addEventListener('resize', ()=>{ renderer.setSize(innerWidth, innerHeight); camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); });

/* init pickups array from earlier spawnPickups */
const pickupsGlobal = pickups; // variable exists
// expose some helpers to console for debugging
window.SAVE = SAVE; window.localPlayer = localPlayer; window.players = players;

updateHpUI();
renderShop();
renderInventory();

</script>
</body>
</html>